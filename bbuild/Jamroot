# -*- coding: iso-8859-1-unix -*-

import os ;
import preloader ;

path-constant here : . ;
path-constant root : $(here)/.. ;
path-constant deps : $(root)/.. ;

local lua = [ os.environ LUA ] ;
if ! $(lua)
{
  lua = "$(deps)/lua" ;
}
use-project lua : $(lua)/bbuild ; 

using preloader : $(lua) ;

project loop
  : requirements
    <target-os>windows:<pch>off
    <target-os>windows,<link>shared:<runtime-link>shared
    <target-os>windows,<link>static:<runtime-link>static
    <target-os>windows:<debug-store>database
    <target-os>windows:<define>_CRT_SECURE_NO_WARNINGS
    <toolset>msvc-12.0:<cxxflags>/FS
    <debug-symbols>on
  ;

make loop.c
  : $(root)/lua/loop/base.lua
    $(root)/lua/loop/cached.lua
    $(root)/lua/loop/collection/ArrayedMap.lua
    $(root)/lua/loop/collection/ArrayedSet.lua
    $(root)/lua/loop/collection/BiCyclicSets.lua
    $(root)/lua/loop/collection/CyclicSets.lua
    $(root)/lua/loop/collection/LRUCache.lua
    $(root)/lua/loop/collection/OrderedSet.lua
    $(root)/lua/loop/collection/Queue.lua
    $(root)/lua/loop/collection/SortedMap.lua
    $(root)/lua/loop/collection/UnorderedArray.lua
    $(root)/lua/loop/compiler/Arguments.lua
    $(root)/lua/loop/component/base.lua
    $(root)/lua/loop/component/contained.lua
    $(root)/lua/loop/component/dynamic.lua
    $(root)/lua/loop/component/intercepted.lua
    $(root)/lua/loop/component/wrapped.lua
    $(root)/lua/loop/debug/Crawler.lua
    $(root)/lua/loop/debug/Matcher.lua
    $(root)/lua/loop/debug/Verbose.lua
    $(root)/lua/loop/debug/Viewer.lua
    $(root)/lua/loop/hierarchy.lua
    $(root)/lua/loop/multiple.lua
    $(root)/lua/loop/object/Dummy.lua
    $(root)/lua/loop/object/Exception.lua
    $(root)/lua/loop/object/Publisher.lua
    $(root)/lua/loop/object/Wrapper.lua
    $(root)/lua/loop/proto.lua
    $(root)/lua/loop/scoped/debug.lua
    $(root)/lua/loop/scoped.lua
    $(root)/lua/loop/serial/FileStream.lua
    $(root)/lua/loop/serial/Serializer.lua
    $(root)/lua/loop/serial/Stream.lua
    $(root)/lua/loop/serial/StringStream.lua
    $(root)/lua/loop/test/checks.lua
    $(root)/lua/loop/test/Fixture.lua
    $(root)/lua/loop/test/Reporter.lua
    $(root)/lua/loop/test/Results.lua
    $(root)/lua/loop/test/Suite.lua
    $(root)/lua/loop/simple.lua
    $(root)/lua/loop/table.lua
    $(root)/lua/loop.lua
  : preloader.pre-compile
  : <dependency>/lua//stage
    <search>$(root)
    <location>$(here)
;

make luatuple.c
  : $(root)/lua/tuple/weak.lua
    $(root)/lua/tuple.lua
  : preloader.pre-compile
  : <dependency>/lua//stage
    <search>$(root)
    <location>$(here)
  ;

make luacothread.c
  : $(root)/lua/cothread/EventPoll.lua
    $(root)/lua/cothread/Mutex.lua
    $(root)/lua/cothread/plugin/signal.lua
    $(root)/lua/cothread/plugin/sleep.lua
    $(root)/lua/cothread/plugin/socket.lua
    $(root)/lua/cothread/Queue.lua
    $(root)/lua/cothread/socket.lua
    $(root)/lua/cothread/socket/ssl.lua
    $(root)/lua/cothread/Timer.lua
    $(root)/lua/cothread.lua
  : preloader.pre-compile
  : <dependency>/lua//stage
    <search>$(root)
    <location>$(here)
;
  
lib loop
  : loop.c
  : <target-os>windows,<link>shared:<linkflags>"/def:$(here)/loop.def"
    <library>/lua//lua
  :
  : <include>.
  ;
explicit loop ;

lib luatuple
  : luatuple.c
    loop
  : <target-os>windows,<link>shared:<linkflags>"/def:$(here)/luatuple.def"
    <library>/lua//lua
  :
  : <include>.
  ;
explicit luatuple ;

lib luacothread
  : luacothread.c
    loop
  : <target-os>windows,<link>shared:<linkflags>"/def:$(here)/luacothread.def"
    <library>/lua//lua
  :
  : <include>.
  ;
explicit luacothread ;

install stage
  : loop
    luatuple
    luacothread
  : <location>install
  ;
  